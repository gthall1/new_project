var jsCopter={options:{canvas:{width:500,height:300,refreshRate:30},copter:{width:30,height:15,topSpeed:8,acceleration:.15,img:null},physics:{terminalVelocity:6,gravity:.7,friction:.8},walls:{separation:19,width:20,step:5,startHeight:60,maxHeight:120,heightIncreaseInterval:5,heightIncreaseStep:10},obstacles:{separation:250,width:20,height:50},colours:{bg:"#000000",fill:"#ff9900",light:"#ffffff"}},gameData:{copter:{x:20,y:0,speed:0,rotation:0},walls:{counter:0,currentHeight:0,currentStep:0,heightIncreaseInterval:0,current:[]},obstacles:{counter:0,current:[]}},scores:{current:0,top:0,elements:{current:null,top:null},halfStep:0},canvas:null,container:null,canvasInterval:null,drawContext:null,mouseDown:!1,gameRunning:!1,deathText:null,init:function(t,e,a){if(this.container=document.getElementById(e),!this.container)return!1;for(var s in a)for(var i in a[s])this.options[s][i]=a[s][i];this.canvas=this.createCanvas(t),this.initScoring(),this.drawContext=this.canvas.getContext("2d"),this.createBG(),this.resetGameData(),this.createCopter(),this.createInitialWalls(),this.initMouseListener()},createCanvas:function(t){var e=document.createElement("canvas");return e.id=t,e.width=this.options.canvas.width,e.height=this.options.canvas.height,this.container.appendChild(e),e},createBG:function(){var t=this.drawContext;t.clearRect(0,0,this.options.canvas.width,this.options.canvas.height),t.beginPath(),this.roundedRect(t,0,0,this.options.canvas.width,this.options.canvas.height,10),t.fillStyle=this.options.colours.bg,t.fill()},resetGameData:function(){this.scores.current=this.scores.elements.current.innerHTML=0,this.gameData.copter.y=Math.round(this.options.canvas.height/2),this.gameData.walls.currentHeight=this.options.walls.startHeight,this.gameData.walls.currentStep=this.options.walls.step,this.gameData.obstacles.counter=this.options.obstacles.separation-this.options.obstacles.width,this.gameData.obstacles.current.length=0,this.gameData.walls.current.length=0,this.deathText&&(this.deathText.style.display="none"),this.createInitialWalls()},createCopter:function(){var t=this.drawContext;if(this.mouseDown===!0?(this.gameData.copter.speed-=this.options.copter.acceleration,this.gameData.copter.speed<-this.options.copter.topSpeed&&(this.gameData.copter.speed=-this.options.copter.topSpeed),this.gameData.copter.rotation=this.gameData.copter.rotation-.01,this.gameData.copter.rotation<-.25&&(this.gameData.copter.rotation=-.25)):(this.gameData.copter.speed=(this.gameData.copter.speed+this.options.physics.gravity)*this.options.physics.friction,this.gameData.copter.speed>this.options.physics.terminalVelocity&&(this.gameData.copter.speed=this.options.physics.terminalVelocity),this.gameData.copter.rotation=this.gameData.copter.rotation+.02,this.gameData.copter.rotation>0&&(this.gameData.copter.rotation=0)),this.gameData.copter.y=this.gameData.copter.y+this.gameData.copter.speed,t.save(),t.translate(this.gameData.copter.x,this.gameData.copter.y),t.rotate(this.gameData.copter.rotation),this.options.copter.img){var e=this,a=new Image;a.src=e.options.copter.img,a.onload=function(){t.drawImage(a,e.gameData.copter.x,e.gameData.copter.y,a.width,a.height),e.options.copter.width=a.width,e.options.copter.height=a.height}}else t.beginPath(),this.roundedRect(t,0,0,this.options.copter.width,this.options.copter.height,10),t.fillStyle=this.options.colours.light,t.fill();t.restore()},roundedRect:function(t,e,a,s,i,r){t.beginPath(),t.moveTo(e,a+r),t.lineTo(e,a+i-r),t.quadraticCurveTo(e,a+i,e+r,a+i),t.lineTo(e+s-r,a+i),t.quadraticCurveTo(e+s,a+i,e+s,a+i-r),t.lineTo(e+s,a+r),t.quadraticCurveTo(e+s,a,e+s-r,a),t.lineTo(e+r,a),t.quadraticCurveTo(e,a,e,a+r)},initScoring:function(){this.scores.elements.current=this.createScore("current")},createScore:function(t){var e=document.createElement("p");e.id=t+"scorecontainer";var a=document.createTextNode(this.ucFirst(t)+" score: ");e.appendChild(a);var s=document.createElement("strong");s.id=t+"score";var i=document.createTextNode("0");return s.appendChild(i),e.appendChild(s),this.container.appendChild(e),s},initMouseListener:function(){var t=this;document.onmousedown=function(e){e.target.id==t.canvas.id&&(t.mouseDown=!0,t.gameRunning===!1&&t.startGame())},document.onmouseup=function(){t.mouseDown=!1}},startGame:function(){this.resetGameData(),this.gameRunning=!0,this.canvasInterval=setInterval("jsCopter.draw()",this.options.canvas.refreshRate)},draw:function(){var t=this.checkForImpact();t===!1?(this.createBG(),this.createCopter(),this.createWalls(),this.createObstacles(),this.updateScore()):this.endGame()},checkForImpact:function(){if(this.gameData.obstacles.current.length>=1)for(var t=this.gameData.obstacles.current.length-1;t>=0;t--)if(this.gameData.obstacles.current[t].x>=this.gameData.copter.x&&this.gameData.obstacles.current[t].x<=this.gameData.copter.x+this.options.obstacles.width&&this.gameData.copter.y>=this.gameData.obstacles.current[t].y&&this.gameData.copter.y<=this.gameData.obstacles.current[t].y+this.options.obstacles.height)return!0;for(var e=0;e<this.gameData.walls.current.length;e++)if(this.gameData.walls.current[e].x<this.options.walls.width+this.options.copter.width&&(this.gameData.walls.current[0].width==this.options.canvas.width+this.options.walls.width||this.gameData.walls.current[e].x>=0)&&(this.gameData.copter.y<this.gameData.walls.current[e].height||this.gameData.copter.y>this.options.canvas.height-this.options.copter.height-(this.gameData.walls.current[e].y-this.gameData.walls.current[e].height)))return!0;return this.gameData.copter.y<0||this.gameData.copter.y>this.options.canvas.height-this.options.copter.height?!0:!1},createInitialWalls:function(){var t=this.drawContext,e={x:0,y:this.gameData.walls.currentHeight,width:this.options.canvas.width+this.options.walls.width,height:this.gameData.walls.currentHeight/2};this.gameData.walls.current.push(e),t.save(),t.beginPath(),t.fillStyle=this.options.colours.fill,t.fillRect(e.x,0,e.width,e.height),t.fill(),t.restore(),t.beginPath(),t.fillStyle=this.options.colours.fill,t.fillRect(e.x,this.options.canvas.height-e.height,e.width,e.height),t.fill()},createWalls:function(){var t=this.drawContext;if(this.gameData.walls.counter++>=Math.floor(this.options.walls.separation/this.options.copter.topSpeed)){var e,a=this.gameData.walls.current[this.gameData.walls.current.length-1].height,s=Math.round(Math.random()),i=Math.round(10*Math.random());e=10==i?this.gameData.walls.currentHeight/2:1==s?a+Math.floor(Math.random()*this.gameData.walls.currentStep):a-Math.floor(Math.random()*this.gameData.walls.currentStep),e>this.gameData.walls.currentHeight&&(e=this.gameData.walls.currentHeight-this.gameData.walls.currentStep),0>e&&(e=this.gameData.walls.currentStep);var r={x:this.options.canvas.width,y:this.gameData.walls.currentHeight,width:this.options.walls.width,height:e};this.gameData.walls.current.push(r),this.gameData.walls.counter=0}for(var o=0;o<this.gameData.walls.current.length;o++)t.save(),t.beginPath(),t.fillStyle=this.options.colours.fill,t.fillRect(this.gameData.walls.current[o].x-=this.options.copter.topSpeed,0,this.gameData.walls.current[o].width,this.gameData.walls.current[o].height),t.fill(),t.restore(),t.beginPath(),t.fillStyle=this.options.colours.fill,t.fillRect(this.gameData.walls.current[o].x,this.options.canvas.height-(this.gameData.walls.current[o].y-this.gameData.walls.current[o].height),this.gameData.walls.current[o].width,this.gameData.walls.current[o].y-this.gameData.walls.current[o].height),t.fill(),this.gameData.walls.current[o].x<=-(2*this.gameData.walls.current[o].width)&&this.gameData.walls.current.splice(o,1)},createObstacles:function(){var t=this.drawContext;if(this.gameData.obstacles.counter++>=Math.floor(this.options.obstacles.separation/this.options.copter.topSpeed)){this.gameData.walls.currentHeight<=this.options.walls.maxHeight&&this.options.walls.heightIncreaseInterval>0&&this.gameData.walls.heightIncreaseInterval++==this.options.walls.heightIncreaseInterval&&(this.gameData.walls.currentHeight+=this.options.walls.heightIncreaseStep,this.gameData.walls.currentStep++,this.gameData.walls.heightIncreaseInterval=0);var e={x:this.options.canvas.width,y:Math.floor(Math.random()*(this.options.canvas.height-2*this.gameData.walls.currentHeight)+this.gameData.walls.currentHeight/2)};this.gameData.obstacles.current.push(e),this.gameData.obstacles.counter=0}for(var a=0;a<this.gameData.obstacles.current.length;a++)t.beginPath(),t.fillStyle=this.options.colours.fill,this.roundedRect(t,this.gameData.obstacles.current[a].x-=this.options.copter.topSpeed,this.gameData.obstacles.current[a].y,this.options.obstacles.width,this.options.obstacles.height,10),t.fill(),this.gameData.obstacles.current[a].x<=-this.options.canvas.width&&this.gameData.obstacles.current.splice(a,1)},updateScore:function(){this.scores.halfStep=0==this.scores.halfStep?1:0,1==this.scores.halfStep&&(this.scores.current++,this.scores.elements.current.innerHTML=this.scores.current)},endGame:function(){var t=$("#game_token").val();if($.ajax({type:"GET",url:"/heliwin",data:{token:t,score:this.scores.current}}).done(function(t){if("success"==t.status){if(t.win===!0){var e=$("#credits").data("user-credits");$(".outcome").html("You won "+t.earned+" credit(s) for a total of "+t.total_credits+" credit(s) so far! Click again for another chance!"),$("#credit_count").html(e+t.total_credits)}else $(".outcome").html("Sorry you lost! So far you have earned "+t.total_credits+" in this game session! Click again for another chance!");t.score&&$(".scorebox").html("Your new high score is "+t.score+"!"),"none"!=t.partner_image&&$(".ad-space").html("<img style='max-height:100px' src='"+t.partner_image+"' />")}else"closed"==t.status&&$(".outcome").html("Sorry this game has closed!")}),this.deathText)this.deathText.style.display="block";else{this.deathText=document.createElement("p"),this.deathText.id="deathtext";var e=document.createTextNode("CRASH!");this.deathText.appendChild(e),this.container.appendChild(this.deathText)}clearInterval(this.canvasInterval),this.gameRunning=!1},ucFirst:function(t){return t}};
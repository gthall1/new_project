function CGame(e){var t,o,r,n,a,i,s,g,l,h,_,c,u,d,f,v,m,S,L,A,p,x,C,E,B=!1,M=1,y=-1,I=null,F=null,T=null;this._init=function(){if(s_oBezier=new CBezier,E=new createjs.Container,L=new createjs.Bitmap(s_oSpriteLibrary.getSprite("bg_game_"+M)),E.addChild(L),s_oStage.addChild(E),S=new CHero,s=0,x=new createjs.Container,p=new createjs.Container,C=new createjs.Container,this.reset(),s_oStage.addChild(x),s_oStage.addChild(p),s_oStage.addChild(C),A=new CInterface,s_bMobile===!1){var e=this;s_oStage.addEventListener("stagemousemove",function(t){e._onMouseMove(t.stageX,t.stageY)})}B=!0},this.unload=function(){B=!1,clearInterval(h),createjs.Sound.stop(),A.unload(),S.unload(),s_oStage.removeAllChildren()},this.reset=function(){t=!0,o=!1,r=!1,i=s_oLevelSettings.getBallSpeedForLevel(M),a=s_oLevelSettings.getBallNumberForLevel(M),c=s_oLevelSettings.getBallColorsForLevel(M),BALL_ROLLING_IN=Math.floor(.33*a),g=0,l=1,n=1,u=0,S.reset(s_oLevelSettings.getHeroPosForLevel(M),c),null!==F&&(x.removeChild(F),x.removeChild(T)),this._initCurve(),this._initBall()},this._normalize=function(e){var t=this._length(e);return t>0?{x:e.x/t,y:e.y/t}:e},this._length=function(e){return Math.sqrt(e.x*e.x+e.y*e.y)},this._dotProductV2=function(e,t){return e.x*t.x+e.y*t.y},this._angleBetweenVectors=function(e,t){var o=Math.acos(this._dotProductV2(e,t)/(this._length(e)*this._length(t)));return isNaN(o)===!0?0:o},this._rot90CW=function(e){return{x:e.y,y:-e.x}},this._rot90CCW=function(e){return{x:-e.y,y:e.x}},this._rotateVector2D=function(e,t){var o=t.x*Math.cos(e)+t.y*Math.sin(e),r=t.x*-Math.sin(e)+t.y*Math.cos(e);return{x:o,y:r}},this._initCurve=function(){var e=s_oLevelSettings.getCurveForLevel(M),t=new createjs.Graphics;t.setStrokeStyle(2),t.beginStroke("#fff"),t.moveTo(e[0][0],e[0][1]);for(var o=1;o<e.length-2;++o){var r=(e[o][0]+e[o+1][0])/2,n=(e[o][1]+e[o+1][1])/2;t.quadraticCurveTo(e[o][0],e[o][1],r,n)}t.quadraticCurveTo(e[o][0],e[o][1],e[o+1][0],e[o+1][1]),f=new Array;for(var a=0;a<e.length-2;++a)for(var i=0===a?new createjs.Point(e[0][0],e[0][1]):new createjs.Point((e[a][0]+e[a+1][0])/2,(e[a][1]+e[a+1][1])/2),s=new createjs.Point(e[a+1][0],e[a+1][1]),g=a<=e.length-4?new createjs.Point((e[a+1][0]+e[a+2][0])/2,(e[a+1][1]+e[a+2][1])/2):new createjs.Point(e[a+2][0],e[a+2][1]),l=s_oBezier.init(i,s,g,STEP_LENGTH),h=1;l>=h;++h){var _=s_oBezier.getAnchorPoint(h);f.push(_)}var c,u,d,v=16;for(t.setStrokeStyle(4),t.beginStroke("#00a29b"),t.beginFill("#221910"),c={x:f[1][0]-f[0][0],y:f[1][1]-f[0][1]},c=this._normalize(c),c=this._rot90CW(c),c.x*=v,c.y*=v,c.x+=f[0][0],c.y+=f[0][1],d={x:c.x,y:c.y},t.moveTo(c.x,c.y),u=1;u<f.length-1;u++)c={x:f[u+1][0]-f[u][0],y:f[u+1][1]-f[u][1]},c=this._normalize(c),c=this._rot90CW(c),c.x*=v,c.y*=v,c.x+=f[u][0],c.y+=f[u][1],t.lineTo(c.x,c.y);for(t.lineTo(c.x,c.y),c={x:f[f.length-1][0]-f[f.length-2][0],y:f[f.length-1][1]-f[f.length-2][1]},c=this._normalize(c),c=this._rot90CCW(c),c.x*=v,c.y*=v,c.x+=f[f.length-1][0],c.y+=f[f.length-1][1],t.lineTo(c.x,c.y),u=f.length-2;u>1;u--)c={x:f[u][0]-f[u-1][0],y:f[u][1]-f[u-1][1]},c=this._normalize(c),c=this._rot90CCW(c),c.x*=v,c.y*=v,c.x+=f[u][0],c.y+=f[u][1],t.lineTo(c.x,c.y);t.lineTo(d.x,d.y),t.endFill(),F=new createjs.Shape(t),x.addChild(F);var m=f.length,S=s_oSpriteLibrary.getSprite("end_path");T=new createjs.Bitmap(S),T.x=f[m-9][0],T.y=f[m-9][1],T.regX=S.width/2,T.regY=S.height/2,x.addChild(T)},this._initBall=function(){d=new Array;var e=this.getRandomBall();d.unshift(e),e.setPos(16,f),y=STATE_GAME_ROLL_IN},this.getRandomBall=function(){a--;var e=Math.floor(Math.random()*c);return new CBall(e,p)},this._pushNextBall=function(e,a){var i=new Array;i.push(d[e]);for(var s=e;s<d.length-1&&d[s+1].getFotogram()-d[s].getFotogram()<=16;++s)d[s+1].getFotogram()-d[s].getFotogram()<16&&d[s+1].setPos(d[s].getFotogram()+16,f),i.push(d[s+1]);for(var g=0;g<i.length;++g)i[g].increasePos(a,f);if(d[d.length-1].getFotogram()>=f.length-17){if(t=!1,DISABLE_SOUND_MOBILE===!1||s_bMobile===!1){s_oSoundtrack.pause();var l=createjs.Sound.play("game_over");l.addEventListener("complete",this._onSoundGameOverComplete)}s_oStage.removeEventListener("stagemousemove"),o=!1,r=!1,n=1,d[d.length-1].unload(),d.splice(d.length-1,1),y=STATE_GAME_ROLL_OUT}},this.onIntroduceBall=function(){if(0!==d.length&&(s_oGame._pushNextBall(0,1),32===d[0].getFotogram()&&0!==a)){var e=s_oGame.getRandomBall();d.unshift(e),e.setPos(16,f)}},this.shoot=function(){(DISABLE_SOUND_MOBILE===!1||s_bMobile===!1)&&createjs.Sound.play("shot");var e=(S.getRotation()+90)*Math.PI/180,t=S.getCurrentBall();t.changePos(S.getX()+60*Math.cos(e),S.getY()+60*Math.sin(e)),p.addChild(t.getSprite()),t.setContainer(p),v.push(new Array(t,e)),y=STATE_GAME_SHOOTING},this._checkCollision=function(e){for(var t=e[0],o=0;o<d.length;++o){var r=(d[o].getX()-t.getX())*(d[o].getX()-t.getX())+(d[o].getY()-t.getY())*(d[o].getY()-t.getY());if(BALL_DIAMETER_SQUARE>=r)return o}return-1},this._insertBall=function(e,t,r){var n,a,i;"next"===r?(i=d[t].getFotogram()+16,d[t+1]&&d[t+1].getFotogram()-d[t].getFotogram()<32&&(m.push(new Array(e,d[t+1])),o=!0)):d[t-1]&&d[t].getFotogram()-d[t-1].getFotogram()<32?(i=d[t-1].getFotogram()+16,m.push(new Array(e,d[t])),o=!0):i=d[t].getFotogram()-16,n=f[i][0],a=f[i][1];var s=this;createjs.Tween.get(e.getSprite()).to({x:n,y:a},200).call(function(){s.motionFinished(e,i)})},this.motionFinished=function(e,t){for(var o,r=0;r<d.length;++r){if(d[r].getFotogram()>t){o=r;break}r===d.length-1&&(o=r+1)}m.splice(m.indexOf(e),1),e.setPos(t,f),d.splice(o,0,e),d[o-1]&&d[o-1].getIndex()===d[o].getIndex()&&d[o].getFotogram()-d[o-1].getFotogram()>17&&this._addToBallAttracted(d[o]),d[o+1]&&d[o+1].getIndex()===d[o].getIndex()&&d[o+1].getFotogram()-d[o].getFotogram()>17&&this._addToBallAttracted(d[o+1]),this._clearCheck(o,!0)},this._addToBallAttracted=function(e){null===I?(I=new Array,I.push(e)):I.push(e),setTimeout(function(){r=!0},400)},this._clearCheck=function(e,t){var o=new Array;o.push(d[e]);for(var r=d[e].getIndex(),n=e+1;d[n]&&d[n].getIndex()===r;)if(d[n].getFotogram()-d[n-1].getFotogram()<=17)o.push(d[n]),++n;else{if(t)break;o.push(d[n]),++n}for(var a=e-1;d[a]&&d[a].getIndex()===r;)if(d[a+1].getFotogram()-d[a].getFotogram()<=17)o.push(d[a]),--a;else{if(t)break;o.push(d[a]),--a}return++a,o.length>2&&t&&this._clearBall(a,o),o.length},this._attract=function(){if(0!==I.length)for(var e=0;e<I.length;++e){var t=d.indexOf(I[e]);if(-1!==t&&d[t-1])if(I[e].getIndex()===d[t-1].getIndex()){var o=I[e].getFotogram()-d[t-1].getFotogram()>19?3:I[e].getFotogram()-d[t-1].getFotogram()-16;this._pushNextBall(t,-o),I[e].getFotogram()-d[t-1].getFotogram()<=16&&(n++,I.splice(e,1),this._clearCheck(t-1,!0),0===I.length&&(r=!1,n=1))}else I.splice(e,1),g>l&&(l=g),g=0}else r=!1,n=1},this._checkPushCollision=function(){if(0!==m.length)for(var e=0;e<m.length;++e){for(var t=(m[e][0].getX()-m[e][1].getX())*(m[e][0].getX()-m[e][1].getX())+(m[e][0].getY()-m[e][1].getY())*(m[e][0].getY()-m[e][1].getY()),r=BALL_DIAMETER_SQUARE>t?!0:!1,n=0;r;)++n,t=(m[e][0].getX()-f[m[e][1].getFotogram()+n][0])*(m[e][0].getX()-f[m[e][1].getFotogram()+n][0])+(m[e][0].getY()-f[m[e][1].getFotogram()+n][1])*(m[e][0].getY()-f[m[e][1].getFotogram()+n][1]),r=BALL_DIAMETER_SQUARE>t?!0:!1;var a;a=d.indexOf(m[e][1]),-1!==a&&this._pushNextBall(a,n)}else o=!1},this._clearBall=function(e,o){++g,(DISABLE_SOUND_MOBILE===!1||s_bMobile===!1)&&createjs.Sound.play("combo");for(var r=0,i=0;i<o.length;++i)o[i].explode(),r+=COMBO_VALUE;if(r*=n,s+=r,A.refreshScore(s),d.length===o.length&&(t=!1,_=d[d.length-1].getFotogram(),setTimeout(this._gamePass,600),DISABLE_SOUND_MOBILE===!1||s_bMobile===!1)){s_oSoundtrack.pause();var h=createjs.Sound.play("win");h.addEventListener("complete",this._onSoundGameOverComplete)}d.splice(e,o.length),0===a&&this._checkColor(o[0].getIndex()),d[e-1]&&d[e]&&d[e-1].getIndex()===d[e].getIndex()?(this._clearCheck(e,!1)<3&&(g>l&&(l=g),g=0),this._addToBallAttracted(d[e])):(g>l&&(l=g),g=0)},this._gamePass=function(){h=setInterval(s_oGame._extraScore,i)},this._extraScore=function(){_+16<f.length-17?(_+=16,new CExtraScore(f[_][0],f[_][1],C),s+=EXTRA_SCORE,A.refreshScore(s)):(clearInterval(h),s_oStage.removeEventListener("stagemousemove"),t=!1,M++,M>s_oLevelSettings.getNumLevels()?A.win(s):A.nextLevel(M,s))},this._checkColor=function(e){for(var t=0;t<d.length;++t)if(d[t].getIndex()===e)return;for(var o=0;o<v.length;++o)if(v[o].getIndex()===e)return;S.colorCleared(e)},this.nextLevel=function(){E.removeChild(L),L=new createjs.Bitmap(s_oSpriteLibrary.getSprite("bg_game_"+M)),E.addChild(L),this.reset(),B=!0},this.onShot=function(e,o){if(t&&S.canShoot()){if(s_bMobile){var r=e-S.getX(),n=o-S.getY(),a=Math.atan2(n,r);S.rotate(180*a/Math.PI-90)}this.shoot()}},this._onMouseMove=function(e,t){var o=e-S.getX(),r=t-S.getY(),n=Math.atan2(r,o);S.rotate(180*n/Math.PI-90)},this.onExit=function(){createjs.Sound.stop(),this.unload(),s_oMain.gotoMenu(),$(s_oMain).trigger("restart")},this._onSoundGameOverComplete=function(){s_oSoundtrack.resume()},this._updateMove=function(){u+=s_iTimeElaps,u>i&&(u=0,this.onIntroduceBall())},this._updateRollOut=function(){for(var e=d.length-1;e>=0;--e)d[e].getFotogram()>f.length-17?(d[e].unload(),d.splice(e,1),0===d.length&&(y=-1,A.gameOver(s))):d[e].increasePos(8,f)},this._updateRollIn=function(){if(d.length<BALL_ROLLING_IN){for(var e=0;e<d.length;++e)d[e].increasePos(4,f);if(32===d[0].getFotogram()){var t=this.getRandomBall();d.unshift(t),t.setPos(16,f)}}else y=-1,v=new Array,m=new Array,S.start(),y=STATE_GAME_BALL_MOVE},this._updateShooting=function(){if(0!==v.length)for(var e=0;e<v.length;++e)if(v[e][0].getX()>0&&v[e][0].getX()<CANVAS_WIDTH&&v[e][0].getY()>0&&v[e][0].getY()<CANVAS_HEIGHT){var t=this._checkCollision(v[e]);if(-1===t)v[e][0].increasePosWithNumbers(Math.cos(v[e][1])*BALL_SHOOTED_SPEED,Math.sin(v[e][1])*BALL_SHOOTED_SPEED);else{var o=v[e][0],r=v[e][1],n=Math.sqrt((d[t].getX()-o.getX())*(d[t].getX()-o.getX())+(d[t].getY()-o.getY())*(d[t].getY()-o.getY()));v[e][0].decreasePos((BALL_DIAMETER-n)*Math.cos(r),(BALL_DIAMETER-n)*Math.sin(r));var a=f[d[t].getFotogram()-BALL_RADIUS][0],i=f[d[t].getFotogram()-BALL_RADIUS][1],s=Math.sqrt((o.getX()-a)*(o.getX()-a)+(o.getY()-i)*(o.getY()-i)),g=f[d[t].getFotogram()+BALL_RADIUS][0],l=f[d[t].getFotogram()+BALL_RADIUS][1],h=Math.sqrt((o.getX()-g)*(o.getX()-g)+(o.getY()-l)*(o.getY()-l)),_=s>h?"next":"previous";this._insertBall(v[e][0],t,_),v.splice(e,1)}}else v[e][0].unload(),v.splice(e,1);else y=-1},this.update=function(){if(B!==!1)switch(r===!0&&this._attract(),o===!0&&this._checkPushCollision(),y){case STATE_GAME_ROLL_IN:this._updateRollIn();break;case STATE_GAME_ROLL_OUT:this._updateRollOut();break;case STATE_GAME_SHOOTING:this._updateShooting(),this._updateMove();break;default:this._updateMove()}},s_oGame=this,COMBO_VALUE=e.combo_value,EXTRA_SCORE=e.extra_score,this._init()}var s_oGame,s_oBezier;
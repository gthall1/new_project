function getRandomImageForTile(){for(var e=Math.floor(Math.random()*tileAllocation.length),t=2;tileAllocation[e]>=t;)e+=1,e>=tileAllocation.length&&(e=0);return e}function createTile(e){var t=new tile("tile"+e),i=getRandomImageForTile();return tileAllocation[i]=tileAllocation[i]+1,image="/assets/"+(i+1)+".jpg",$.ajax({type:"GET",url:"/get_advertiser_logo",data:{id:advertisers[i]}}).done(function(e){image=e.ad_image}),tileImage[i]=image,t.setFrontColor("tileColor1"),t.setStartAt(500*Math.floor(5*Math.random()+1)),t.setBackContentImage(image),t}function initState(){for(tileAllocation=new Array(0,0,0,0,0,0,0,0,0,0);tiles.length>0;)tiles.pop();$("#board").empty(),iTimer=0}function startTimer(e,t){var i,l,o=e;setInterval(function(){i=parseInt(o/60,10),l=parseInt(o%60,10),i=10>i?"0"+i:i,l=10>l?"0"+l:l,t.text(i+":"+l),!clockstop&&--o<0&&(o=e)},1e3)}function initTiles(){var e=0,t=null;for(initState(),clockstop=!1,$.ajax({type:"GET",url:"/reset_timer"}).done(function(e){"success"==e.status&&(display=$("#time"),console.log(e.time_left),startTimer(e.time_left,display))}),e=0;20>e;e++)t=createTile(e),$("#board").append(t.getHTML()),tiles.push(t)}function hideTiles(e){var t=0;for(t=0;t<tiles.length;t++)tiles[t].revertFlip();e()}function revealTiles(e){var t=0,i=!1;for(t=0;t<tiles.length;t++)tiles[t].getFlipped()===!1&&(iTimer>tiles[t].getStartAt()?tiles[t].flip():i=!0);iTimer+=iInterval,i===!0?setTimeout("revealTiles("+e+")",iInterval):e()}function playAudio(e){var t=document.getElementById("audioEngine");null!==t&&(t.src=e,t.play())}function checkMatch(){null===iFlippedTile?iFlippedTile=iTileBeingFlippedId:(tiles[iFlippedTile].getBackContentImage()!==tiles[iTileBeingFlippedId].getBackContentImage()?(setTimeout("tiles["+iFlippedTile+"].revertFlip()",2e3),setTimeout("tiles["+iTileBeingFlippedId+"].revertFlip()",2e3)):(matchcount+=1,10==matchcount&&victory()),iFlippedTile=null,iTileBeingFlippedId=null)}function victory(){var e=$("#game_token").val();$.ajax({type:"GET",url:"/memorywin",data:{token:e,match:matchcount,time_left:$("#time").html()}}).done(function(e){if("success"==e.status)if(e.win===!0){var t=$("#credits").data("user-credits");clockstop=!0,$(".outcome").html("You won "+e.earned+" credit(s) for a total of "+e.total_credits+" credit(s) so far! Click 'New Game' again for another chance!"),$("#credit_count").html(t+e.total_credits),e.score&&$(".scorebox").html("Your new high score is "+e.score+"!")}else clockstop=!0,$(".outcome").html("Sorry you lost! So far you have earned "+e.total_credits+" in this game session! Click again for another chance!");else"closed"==e.status&&$(".outcome").html("Sorry this game has closed!")})}function onPeekComplete(){$("div.tile").click(function(){iTileBeingFlippedId=this.id.substring("tile".length),tiles[iTileBeingFlippedId].getFlipped()===!1&&(tiles[iTileBeingFlippedId].addFlipCompleteCallback(function(){checkMatch()}),tiles[iTileBeingFlippedId].flip())})}function onPeekStart(){setTimeout("hideTiles( function() { onPeekComplete(); })",iPeekTime)}var tiles=new Array,iFlippedTile=null,iTileBeingFlippedId=null,advertisers=new Array,tileImage=new Array,tileAllocation=null,iTimer=0,iInterval=100,iPeekTime=3e3,clockstop=!0,matchcount=0;$(document).ready(function(){$("#startGameButton").click(function(e){e.preventDefault(),$.ajax({type:"GET",url:"/get_advertisers"}).done(function(e){console.log("DONE LOADING ADVERTISERS"),advertisers=e.advertisers,initTiles()}),setTimeout("revealTiles(function() { onPeekStart(); })",iInterval)})});